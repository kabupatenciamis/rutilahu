<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIRUCI ‚Äî Dashboard Rutilahu (Final)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root{
      /* Palet Warna Ungu */
      --bg: #f5f3ff;
      --card-bg: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --table-head-bg: #4a007a; /* Ungu gelap */
      --table-head-text: #fff;
      --kpi-blue: #e6f0ff;
      --kpi-green: #e9f7ec;
      --kpi-orange: #fff4e6;
      --kpi-purple: #f1e0ff;
      --main-purple: #6b21a8;
      --light-purple: #8b5cf6;
    }
    body { background: var(--bg); color: var(--text); transition: background 0.3s ease, color 0.3s ease; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    .card { border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.06); background: var(--card-bg); transition: background 0.3s ease, color 0.3s ease; }
    #map { height: 50vh; min-height: 400px; border-radius: 12px; z-index: 1; }
    .kpi-card { text-align: center; font-weight: 500; transition: transform 0.3s ease; }
    .kpi-card:hover { transform: translateY(-5px); }
    .kpi-card h5 { font-size: 1rem; margin-bottom: 0.5rem; color: var(--muted); }
    .kpi-card p { font-size: 2.2rem; font-weight: 700; margin-bottom: 0; transition: color 0.3s ease; }
    .kpi-blue { background: var(--kpi-blue); color: #3b82f6; }
    .kpi-green { background: var(--kpi-green); color: #22c55e; }
    .kpi-orange { background: var(--kpi-orange); color: #f97316; }
    .kpi-purple { background: var(--kpi-purple); color: var(--main-purple); }
    .small-btn { font-size: 0.75rem; padding: 0.15rem 0.5rem; }
    #dataTable th.sortable { cursor: pointer; position: relative; }
    #dataTable th.sortable.asc::after { content: ' ‚ñ≤'; font-size: 0.8em; }
    #dataTable th.sortable.desc::after { content: ' ‚ñº'; font-size: 0.8em; }
    #dataTable tbody td { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
    .table-responsive { overflow: auto; }
    #dataTable tbody tr.selected { background-color: #e3f2fd !important; }
    #login-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1050;
    }
    .dark-mode {
      --bg: #1f2937;
      --card-bg: #374151;
      --text: #f3f4f6;
      --muted: #d1d5db;
      --table-head-bg: #111827;
      --table-head-text: #fff;
    }
    .dark-mode .card { color: var(--text); }
  </style>
</head>
<body>

<div class="container-fluid p-4">
  <div class="d-flex align-items-center mb-4">
    <h3 class="me-auto" style="color:var(--main-purple);">Dashboard SIRUCI <small class="text-muted">(Sistem Informasi Rutilahu Ciamis)</small></h3>
    <a href="#" id="logoutBtn" class="btn btn-sm btn-outline-danger">
      <i class="fa-solid fa-right-from-bracket"></i> Logout
    </a>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="card p-3 kpi-card kpi-blue">
        <h5>Total Data</h5>
        <p id="totalData">0</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 kpi-card kpi-green">
        <h5>Kecamatan</h5>
        <p id="totalKecamatan">0</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 kpi-card kpi-orange">
        <h5>Desa</h5>
        <p id="totalDesa">0</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 kpi-card kpi-purple">
        <h5>Total Penghuni</h5>
        <p id="totalPenghuni">0</p>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card p-3 h-100">
        <h5 class="card-title">Peta Persebaran Data</h5>
        <div id="map"></div>
        <small class="ms-auto text-muted mt-2">
          (Admin) Klik pada peta untuk menyimpan koordinat ke baris yang dipilih.
        </small>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 h-100">
        <h5 class="card-title">Grafik Data</h5>
        <div class="d-flex align-items-center mb-2">
          <div class="form-check form-switch ms-auto">
            <input class="form-check-input" type="checkbox" role="switch" id="togglePerDesa" checked>
            <label class="form-check-label" for="togglePerDesa">Tampilkan per Desa</label>
          </div>
        </div>
        <div style="height: calc(100% - 40px);"><canvas id="chartCanvas"></canvas></div>
      </div>
    </div>
  </div>

  <div class="card p-3">
    <h5 class="card-title">Tabel Data</h5>
    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
      <div class="input-group" style="max-width:300px;">
        <span class="input-group-text">üîç</span>
        <input type="text" class="form-control" placeholder="Cari Nama/NIK..." id="searchInput">
      </div>
      <select id="filterKecamatan" class="form-select" style="max-width:200px;"></select>
      <select id="filterDesa" class="form-select" style="max-width:200px;"></select>
      
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-secondary" id="resetFilters">
          <i class="fa-solid fa-filter-circle-xmark"></i> Reset Filter
        </button>
        <button type="button" class="btn btn-outline-secondary" id="resetSort">
          <i class="fa-solid fa-sort"></i> Reset Urutan
        </button>
      </div>
      
      <div class="ms-auto btn-group" role="group">
        <label for="fileInput" class="btn btn-outline-secondary">
          <i class="fa-solid fa-file-excel"></i> <span>Unggah XLSX</span>
          <input type="file" id="fileInput" style="display:none;" accept=".xlsx,.xls,.csv">
        </label>
        <button type="button" class="btn btn-outline-secondary" id="downloadTemplate">
          <i class="fa-solid fa-download"></i> Template
        </button>
        <button type="button" class="btn btn-success" onclick="addRow()">
          <i class="fa-solid fa-plus-circle"></i> Tambah Baris
        </button>
        <button type="button" class="btn btn-outline-primary" onclick="exportExcel()">
          <i class="fa-solid fa-share-from-square"></i> Ekspor XLSX
        </button>
        <button type="button" class="btn btn-danger" id="clearData">
          <i class="fa-solid fa-trash-can"></i> Hapus Semua Data
        </button>
      </div>
    </div>
    <div class="table-responsive">
      <table id="dataTable" class="table table-hover table-striped">
        <thead class="bg-dark text-white">
          <tr>
            <th class="sortable">Nama</th>
            <th class="sortable">No. KK</th>
            <th class="sortable">No. NIK</th>
            <th class="sortable">Alamat</th>
            <th class="sortable">Kecamatan</th>
            <th class="sortable">Desa</th>
            <th class="sortable">Luas Rumah</th>
            <th class="sortable">Jml Penghuni</th>
            <th class="sortable">Latitude</th>
            <th class="sortable">Longitude</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="d-flex align-items-center">
        <span>Baris per halaman:</span>
        <select id="pageSizeSel" class="form-select form-select-sm ms-2" style="width: auto;">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div id="pagination" class="btn-group" role="group"></div>
      <div id="pageInfo" class="text-muted"></div>
    </div>
  </div>
</div>

<div id="login-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(5px);display:flex;justify-content:center;align-items:center;z-index:1050;">
  <div class="card p-4" style="width:100%;max-width:400px;text-align:center;">
    <h5 class="card-title mb-3">Login ke SIRUCI</h5>
    <div class="mb-3">
      <input type="email" id="adminEmail" class="form-control" placeholder="Email Admin (hanya admin)" disabled>
    </div>
    <div class="mb-3">
      <input type="password" id="adminPassword" class="form-control" placeholder="Password Admin">
    </div>
    <div class="d-grid gap-2">
      <button class="btn btn-primary" id="loginAdminBtn">Login sebagai Admin</button>
      <button class="btn btn-outline-secondary" id="loginViewerBtn">Login sebagai Viewer</button>
    </div>
    <div id="loginErrorMsg" class="text-danger mt-2" style="display:none;"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
  // -------------------------
  // Config / state
  // -------------------------
  const LS_THEME = 'rutilahu_theme_v1';
  const LS_COLOR = 'rutilahu_icon_color_v1';
  const LS_SORT = 'rutilahu_sort_v1';
  const COLOR_MAP = {
    blue:  {fill:'#6b21a8', stroke:'#8b5cf6', strokeDark:'#f3e8ff'},
    green: {fill:'#22c55e', stroke:'#16a34a', strokeDark:'#86efac'},
    red:   {fill:'#ef4444', stroke:'#b91c1c', strokeDark:'#fca5a5'},
    orange:{fill:'#f97316', stroke:'#c2410c', strokeDark:'#fdba74'},
    purple:{fill:'#6b21a8', stroke:'#8b5cf6', strokeDark:'#f3e8ff'}
  };

  let globalData = [];
  let filteredView = [];
  let selectedGlobalIndex = null;
  let chart, markersLayer;
  let map = L.map('map').setView([-7.33, 108.33], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: '¬© OpenStreetMap' }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);

  let currentPage = 1;
  let pageSize = parseInt(localStorage.getItem('rutilahu_page_size')||'10',10);

  // -------------------------
  // Firebase Configuration
  // -------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCSdubntMjMsOFIHNl-z9f6GTnBEJsz8qk",
    authDomain: "rutilahu-ciamis.firebaseapp.com",
    projectId: "rutilahu-ciamis",
    storageBucket: "rutilahu-ciamis.appspot.com",
    messagingSenderId: "785824428340",
    appId: "1:785824428340:web:aec44a0b8307d7ed247561",
    databaseURL: "https://rutilahu-ciamis-default-rtdb.firebaseio.com/"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  
  // -------------------------
  // Login & User Role
  // -------------------------
  const adminEmail = 'admin@ciamis.go.id';
  let userRole = null;

  function showLoginOverlay(){
    document.getElementById('login-overlay').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function hideLoginOverlay(){
    document.getElementById('login-overlay').style.display = 'none';
    document.body.style.overflow = '';
  }

  function applyUserRole(){
    const isAdmin = userRole === 'admin';
    
    document.getElementById('fileInput').disabled = !isAdmin;
    document.getElementById('downloadTemplate').disabled = !isAdmin;
    const addRowBtn = document.querySelector('button[onclick="addRow()"]');
    if (addRowBtn) addRowBtn.disabled = !isAdmin;
    const exportExcelBtn = document.querySelector('button[onclick="exportExcel()"]');
    if (exportExcelBtn) exportExcelBtn.disabled = !isAdmin;
    document.getElementById('clearData').disabled = !isAdmin;
    
    document.querySelectorAll('#dataTable tbody td[contenteditable]').forEach(el => el.setAttribute('contenteditable', isAdmin));
    document.querySelectorAll('.btn-danger, .btn-success').forEach(el => el.style.display = isAdmin ? '' : 'none');
    const tableHint = document.querySelector('.ms-auto.text-muted');
    if (tableHint) tableHint.style.display = isAdmin ? '' : 'none';

    document.getElementById('logoutBtn').style.display = userRole ? '' : 'none';

    if (userRole) {
      hideLoginOverlay();
    }
  }

  // Handle Firebase Auth State Changes
  auth.onAuthStateChanged(user => {
    if (user) {
      if (user.isAnonymous) {
        userRole = 'viewer';
      } else if (user.email === adminEmail) {
        userRole = 'admin';
      } else {
        userRole = 'viewer';
      }
      applyUserRole();
      loadFromFirebase();
    } else {
      userRole = null;
      applyUserRole();
      showLoginOverlay();
    }
  });

  // Event Listeners for Login Buttons
  document.getElementById('loginAdminBtn').addEventListener('click', () => {
    const password = document.getElementById('adminPassword').value;
    const errorMsg = document.getElementById('loginErrorMsg');
    // Asumsi email admin telah didaftarkan di Firebase
    auth.signInWithEmailAndPassword(adminEmail, password)
      .then(() => {
        errorMsg.style.display = 'none';
      })
      .catch((error) => {
        errorMsg.innerText = 'Login gagal: ' + error.message;
        errorMsg.style.display = 'block';
      });
  });

  document.getElementById('loginViewerBtn').addEventListener('click', () => {
    auth.signInAnonymously()
      .then(() => {})
      .catch((error) => {
        alert('Login sebagai Viewer gagal: ' + error.message);
      });
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    auth.signOut().then(() => {
      // Sign-out successful. onAuthStateChanged will handle UI changes
    }).catch((error) => {
      console.error("Logout error:", error);
    });
  });
  
  // -------------------------
  // Helpers
  // -------------------------
  function safeFloat(v){ let n = parseFloat(v); return isNaN(n)? null : n; }
  function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // -------------------------
  // Database Save/Load with Firebase
  // -------------------------
  function saveToFirebase(){
    if (userRole === 'admin') {
      db.ref('rutilahu_data').set(globalData)
        .then(() => { console.log('Data saved to Firebase.'); })
        .catch(e => { console.error('Failed to save to Firebase:', e); });
    }
  }

  function loadFromFirebase(){
    db.ref('rutilahu_data').on('value', (snapshot) => {
      const data = snapshot.val();
      if (Array.isArray(data)) {
        globalData = data.map(r=>({
          Nama: r.Nama||'', NoKK: r.NoKK||'', NoNIK: r.NoNIK||'', Alamat: r.Alamat||'', Kecamatan: r.Kecamatan||'', Desa: r.Desa||'',
          LuasRumah: safeFloat(r.LuasRumah) || 0, JumlahPenghuni: parseInt(r.JumlahPenghuni)||0,
          Latitude: safeFloat(r.Latitude), Longitude: safeFloat(r.Longitude)
        }));
      } else {
        globalData = [];
      }
      populateFilters();
      applyFilters();
      console.log('Data loaded from Firebase.');
    }, (error) => {
      console.error('Error loading data from Firebase:', error);
    });
  }

  // -------------------------
  // File upload
  // -------------------------
  document.getElementById('fileInput').addEventListener('change', handleFile, false);
  function handleFile(ev){
    const f = ev.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type: 'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const arr = XLSX.utils.sheet_to_json(ws, {defval: ''});
      globalData = arr.map(r => ({
        Nama: r.Nama || r.nama || r.name || '',
        NoKK: r.NoKK || r.No_KK || r['No KK'] || '',
        NoNIK: r.NoNIK || r.No_NIK || r['No NIK'] || '',
        Alamat: r.Alamat || r.alamat || '',
        Kecamatan: r.Kecamatan || r.kecamatan || '',
        Desa: r.Desa || r.desa || '',
        LuasRumah: safeFloat(r.LuasRumah || r['Luas Rumah'] || r.luas) || 0,
        JumlahPenghuni: parseInt(r.JumlahPenghuni || r['Jumlah Penghuni'] || r.jumlah) || 0,
        Latitude: safeFloat(r.Latitude || r.Lat || r.lat) ,
        Longitude: safeFloat(r.Longitude || r.Lng || r.lng)
      }));
      populateFilters();
      applyFilters();
      saveToFirebase();
    };
    reader.readAsArrayBuffer(f);
  }

  // -------------------------
  // Filters & search
  // -------------------------
  function populateFilters(){
    const kecSet = new Set();
    const desaSet = new Set();
    globalData.forEach(d => { if(d.Kecamatan) kecSet.add(d.Kecamatan); if(d.Desa) desaSet.add(d.Desa); });
    const kecSel = document.getElementById('filterKecamatan');
    const desaSel = document.getElementById('filterDesa');
    kecSel.innerHTML = '<option value="">Semua</option>';
    desaSel.innerHTML = '<option value="">Semua</option>';
    Array.from(kecSet).sort().forEach(k=> kecSel.innerHTML += `<option value="${k}">${k}</option>`);
    Array.from(desaSet).sort().forEach(d=> desaSel.innerHTML += `<option value="${d}">${d}</option>`);
  }
  document.getElementById('filterKecamatan').addEventListener('change', applyFilters);
  document.getElementById('filterDesa').addEventListener('change', applyFilters);
  document.getElementById('searchInput').addEventListener('input', applyFilters);
  document.getElementById('pageSizeSel').value = pageSize;
  document.getElementById('pageSizeSel').addEventListener('change', (e)=>{ pageSize = parseInt(e.target.value,10); localStorage.setItem('rutilahu_page_size', String(pageSize)); currentPage = 1; renderTable(); });
  document.getElementById('resetFilters').addEventListener('click', ()=>{
      document.getElementById('filterKecamatan').value = '';
      document.getElementById('filterDesa').value = '';
      document.getElementById('searchInput').value = '';
      applyFilters();
  });

  // -------------------------
  // Sorting
  // -------------------------
  let sortConfig = { key: null, asc: true };
  function applySavedSort(){
    const saved = localStorage.getItem(LS_SORT);
    if(!saved) return;
    try{
      const sc = JSON.parse(saved);
      sortConfig = sc;
    }catch(e){ return; }
  }
  function sortFilteredViewIfNeeded(){
    if(!sortConfig.key) return;
    filteredView.sort((a, b) => {
      const valA = (a[sortConfig.key] || "").toString().toLowerCase();
      const valB = (b[sortConfig.key] || "").toString().toLowerCase();
      if(valA < valB) return sortConfig.asc ? -1 : 1;
      if(valA > valB) return sortConfig.asc ? 1 : -1;
      return 0;
    });
  }
  function setHeaderSortUI(){
    document.querySelectorAll("#dataTable thead th.sortable").forEach(thEl => thEl.classList.remove("asc","desc"));
    const keyMap = ["Nama","NoKK","NoNIK","Alamat","Kecamatan","Desa","LuasRumah","JumlahPenghuni","Latitude","Longitude"];
    const idx = keyMap.indexOf(sortConfig.key);
    if(idx >= 0){
      const ths = document.querySelectorAll("#dataTable thead th.sortable");
      if(ths[idx]) ths[idx].classList.add(sortConfig.asc ? "asc":"desc");
    }
  }
  function sortByKey(key, th){
    if(sortConfig.key === key){ sortConfig.asc = !sortConfig.asc; } else { sortConfig.key = key; sortConfig.asc = true; }
    sortFilteredViewIfNeeded();
    currentPage = 1;
    renderTable();
    setHeaderSortUI();
    localStorage.setItem(LS_SORT, JSON.stringify(sortConfig));
  }

  // -------------------------
  // Table render / CRUD
  // -------------------------
  const tbody = document.querySelector('#dataTable tbody');
  function renderTable(){
    tbody.innerHTML = '';
    const total = filteredView.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    if(currentPage > totalPages) currentPage = totalPages;
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageSlice = filteredView.slice(start, end);

    pageSlice.forEach((r, i) => {
      const tr = document.createElement('tr');
      tr.dataset.idx = r._idx;
      const isAdmin = userRole === 'admin';
      tr.innerHTML = `
        <td contenteditable="${isAdmin}">${escapeHtml(r.Nama)}</td>
        <td contenteditable="${isAdmin}">${escapeHtml(r.NoKK)}</td>
        <td contenteditable="${isAdmin}">${escapeHtml(r.NoNIK)}</td>
        <td contenteditable="${isAdmin}">${escapeHtml(r.Alamat)}</td>
        <td contenteditable="${isAdmin}">${escapeHtml(r.Kecamatan)}</td>
        <td contenteditable="${isAdmin}">${escapeHtml(r.Desa)}</td>
        <td contenteditable="${isAdmin}">${r.LuasRumah ?? ''}</td>
        <td contenteditable="${isAdmin}">${r.JumlahPenghuni ?? ''}</td>
        <td contenteditable="${isAdmin}">${r.Latitude ?? ''}</td>
        <td contenteditable="${isAdmin}">${r.Longitude ?? ''}</td>
        <td>
          <button class="btn btn-sm btn-success small-btn" onclick="saveRow(this)" style="display:${isAdmin?'':'none'}">
            <i class="fa-solid fa-save"></i>
          </button>
          <button class="btn btn-sm btn-danger small-btn" onclick="deleteRow(this)" style="display:${isAdmin?'':'none'}">
            <i class="fa-solid fa-trash-can"></i>
          </button>
        </td>`;
      tr.addEventListener('click', function(e){ if(e.target.tagName === 'BUTTON') return; selectRow(r._idx, tr); });
      tbody.appendChild(tr);
    });

    renderPagination(total, totalPages);
    document.getElementById('pageInfo').innerText = `Menampilkan ${total===0?0:start+1} - ${Math.min(total, end)} dari ${total} baris`;
  }

  function renderPagination(total, totalPages){
    const pg = document.getElementById('pagination'); pg.innerHTML = '';
    const createBtn = (txt, onClick, disabled=false, cls='btn-secondary')=>{
      const b = document.createElement('button'); b.type='button'; b.className = `btn ${cls} page-btn`; if(disabled) b.disabled=true; b.innerText = txt; b.addEventListener('click', onClick); return b;
    };
    pg.appendChild(createBtn('‚ü®', ()=>{ if(currentPage>1){ currentPage--; renderTable(); } }, currentPage===1));
    const maxButtons = 5;
    let start = Math.max(1, currentPage - Math.floor(maxButtons/2));
    let end = Math.min(totalPages, start + maxButtons -1);
    if(end - start < maxButtons -1) start = Math.max(1, end - maxButtons +1);
    for(let p = start; p<=end; p++){
      const cls = p===currentPage ? 'btn-primary' : 'btn-outline-secondary';
      pg.appendChild(createBtn(p, ()=>{ currentPage = p; renderTable(); } , false, cls));
    }
    pg.appendChild(createBtn('‚ü©', ()=>{ if(currentPage<totalPages){ currentPage++; renderTable(); } }, currentPage===totalPages));
  }

  function selectRow(globalIdx, trElement){
    document.querySelectorAll('#dataTable tbody tr').forEach(t => t.classList.remove('selected'));
    trElement.classList.add('selected');
    selectedGlobalIndex = globalIdx;
  }

  function addRow(){
    if (userRole !== 'admin') return;
    const newObj = { Nama: '', NoKK: '', NoNIK: '', Alamat:'', Kecamatan:'', Desa:'', LuasRumah:0, JumlahPenghuni:0, Latitude:null, Longitude:null };
    globalData.push(newObj);
    populateFilters();
    applyFilters();
    saveToFirebase();
    selectedGlobalIndex = globalData.length - 1;
    setTimeout(()=>{
      const tr = [...document.querySelectorAll('#dataTable tbody tr')].find(t=> parseInt(t.dataset.idx)===selectedGlobalIndex);
      if(tr) { tr.scrollIntoView({behavior:'smooth', block:'center'}); tr.classList.add('selected'); }
    }, 120);
  }

  function saveRow(btn){
    if (userRole !== 'admin') return;
    const tr = btn.closest('tr');
    const idx = parseInt(tr.dataset.idx);
    const cells = tr.querySelectorAll('td');
    globalData[idx] = {
      Nama: cells[0].innerText.trim(),
      NoKK: cells[1].innerText.trim(),
      NoNIK: cells[2].innerText.trim(),
      Alamat: cells[3].innerText.trim(),
      Kecamatan: cells[4].innerText.trim(),
      Desa: cells[5].innerText.trim(),
      LuasRumah: safeFloat(cells[6].innerText) || 0,
      JumlahPenghuni: parseInt(cells[7].innerText) || 0,
      Latitude: safeFloat(cells[8].innerText),
      Longitude: safeFloat(cells[9].innerText)
    };
    populateFilters();
    applyFilters();
    saveToFirebase();
  }

  function deleteRow(btn){
    if (userRole !== 'admin') return;
    const tr = btn.closest('tr');
    const idx = parseInt(tr.dataset.idx);
    if(!confirm('Hapus data ini?')) return;
    globalData.splice(idx,1);
    populateFilters();
    applyFilters();
    saveToFirebase();
    selectedGlobalIndex = null;
  }

  // -------------------------
  // Chart
  // -------------------------
  function updateChart(){
    const perDesa = document.getElementById('togglePerDesa')?.checked;
    const grouped = {};
    filteredView.forEach(r => { const key = perDesa ? (r.Desa||'(Belum diisi)') : (r.Kecamatan||'(Belum diisi)'); grouped[key] = (grouped[key]||0)+1; });
    const labels = Object.keys(grouped);
    const values = Object.values(grouped);
    if(chart) chart.destroy();
    const ctx = document.getElementById('chartCanvas').getContext('2d');
    const filterKec = document.getElementById('filterKecamatan').value;
    const filterDesa = document.getElementById('filterDesa').value;
    let title = perDesa ? 'Jumlah Rutilahu per Desa' : 'Jumlah Rutilahu per Kecamatan';
    if(filterKec) title += ' ‚Äî Kec: ' + filterKec;
    if(filterDesa) title += ', Desa: ' + filterDesa;
    chart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Jumlah Rutilahu', data: values, backgroundColor: 'var(--main-purple)' }] }, options: { responsive:true, maintainAspectRatio:false, plugins: { title: { display: true, text: title, color: 'var(--text)' }, legend: { display: false } }, scales: { x: { ticks: { color: 'var(--muted)' }, grid: { color: 'rgba(0,0,0,0.05)' } }, y: { ticks: { color: 'var(--muted)' }, grid: { color: 'rgba(0,0,0,0.05)' } } } } });
  }

  // -------------------------
  // Map (SVG icons + bounce)
  // -------------------------
  function getSvgIconDataUrl(colorKey, isDark){
    const c = COLOR_MAP[colorKey] || COLOR_MAP.purple;
    if(isDark){
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="${c.strokeDark}" d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8h5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>`);
    } else {
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="${c.fill}" d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8h5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>`);
    }
  }

  function createSvgIcon(){
    const isDark = document.body.classList.contains('dark');
    return L.icon({
      iconUrl: getSvgIconDataUrl('purple', isDark),
      iconSize: [36,36],
      iconAnchor: [18,36],
      popupAnchor: [0,-30]
    });
  }

  function bounceMarker(marker){
    const icon = marker._icon;
    if(!icon) return;
    icon.style.transition = 'transform 0.6s cubic-bezier(.28,.84,.42,1)';
    icon.style.transform = 'translateY(-10px)';
    setTimeout(()=> icon.style.transform = 'translateY(0)', 600);
  }

  function updateMap(){
    if(!markersLayer) return;
    markersLayer.clearLayers();
    const icon = createSvgIcon();
    filteredView.forEach(r => {
      if(r.Latitude != null && r.Longitude != null){
        const m = L.marker([r.Latitude, r.Longitude], {icon}).bindPopup(`
          <div style="font-size: 1rem; line-height: 1.5;">
            <p style="margin: 0; padding: 0;"><b><i class="fa-solid fa-user" style="color: var(--main-purple);"></i> Nama:</b> ${escapeHtml(r.Nama)}</p>
            <p style="margin: 0; padding: 0;"><b><i class="fa-solid fa-id-card" style="color: var(--muted);"></i> No. NIK:</b> ${escapeHtml(r.NoNIK)}</p>
            <p style="margin: 0; padding: 0;"><b><i class="fa-solid fa-location-dot" style="color: var(--muted);"></i> Alamat:</b> ${escapeHtml(r.Alamat)}</p>
            <p style="margin: 0; padding: 0;"><b><i class="fa-solid fa-map-pin" style="color: var(--muted);"></i> Lokasi:</b> Kec. ${escapeHtml(r.Kecamatan)} | Desa ${escapeHtml(r.Desa)}</p>
          </div>
        `);
        markersLayer.addLayer(m);
        m.on('add', ()=> bounceMarker(m));
      }
    });
  }

  map.on('click', function(e){
    if (userRole !== 'admin') {
      alert('Anda tidak memiliki izin untuk mengedit data.');
      return;
    }
    const lat = parseFloat(e.latlng.lat.toFixed(6));
    const lng = parseFloat(e.latlng.lng.toFixed(6));
    if(selectedGlobalIndex === null){ alert('Silakan pilih satu baris pada tabel terlebih dahulu (klik baris) agar koordinat bisa diisi.'); return; }
    globalData[selectedGlobalIndex].Latitude = lat;
    globalData[selectedGlobalIndex].Longitude = lng;
    applyFilters();
    saveToFirebase();
    const m = L.marker([lat, lng], {icon: createSvgIcon()}).addTo(map).bindPopup('Koordinat disimpan ke baris terpilih:<br>' + lat + ', ' + lng).openPopup();
    setTimeout(()=>{ map.removeLayer(m); }, 1800);
  });

  // -------------------------
  // Export / Template
  // -------------------------
  function exportExcel(){
    if (userRole !== 'admin') return;
    const out = globalData.map(r => ({
      Nama: r.Nama||'', NoKK: r.NoKK||'', NoNIK: r.NoNIK||'', Alamat: r.Alamat||'', Kecamatan: r.Kecamatan||'', Desa: r.Desa||'',
      LuasRumah: r.LuasRumah||0, JumlahPenghuni: r.JumlahPenghuni||0, Latitude: r.Latitude||'', Longitude: r.Longitude||''
    }));
    const ws = XLSX.utils.json_to_sheet(out);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Rutilahu');
    XLSX.writeFile(wb, 'Rutilahu_Ciamis_export.xlsx');
  }

  document.getElementById('downloadTemplate').addEventListener('click', ()=>{
    const headers = [{Nama:'Nama contoh',NoKK:'3201...',NoNIK:'3510...',Alamat:'Jl. Contoh',Kecamatan:'Contoh Kec',Desa:'Contoh Desa',LuasRumah:36,JumlahPenghuni:4,Latitude:-7.333333,Longitude:108.333333}];
    const ws = XLSX.utils.json_to_sheet(headers, {header: ['Nama','NoKK','NoNIK','Alamat','Kecamatan','Desa','LuasRumah','JumlahPenghuni','Latitude','Longitude']});
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Template');
    XLSX.writeFile(wb, 'Template_Rutilahu_Ciamis.xlsx');
  });

  document.getElementById('clearData').addEventListener('click', ()=>{
    if (userRole !== 'admin') return;
    if(!confirm('Kosongkan semua data yang sedang dimuat?')) return;
    globalData = [];
    applyFilters();
    populateFilters();
    selectedGlobalIndex = null;
    saveToFirebase();
  });


  // -------------------------
  // KPI + animateNumber
  // -------------------------
  function animateNumber(element, newValue, duration = 500){
    if(!element) return;
    const oldValue = parseInt(String(element.innerText).replace(/\D/g,'')) || 0;
    const diff = newValue - oldValue;
    const start = performance.now();
    function step(timestamp){
      const progress = Math.min((timestamp - start) / duration, 1);
      const value = Math.floor(oldValue + diff * progress);
      element.innerText = value.toLocaleString('id-ID');
      if(progress < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  function updateKPI(){
    animateNumber(document.getElementById('totalData'), globalData.length);
    const kecSet = new Set(globalData.map(d=>d.Kecamatan).filter(Boolean));
    animateNumber(document.getElementById('totalKecamatan'), kecSet.size);
    const desaSet = new Set(globalData.map(d=>d.Desa).filter(Boolean));
    animateNumber(document.getElementById('totalDesa'), desaSet.size);
    const totalPenghuni = globalData.reduce((sum,d)=> sum+(parseInt(d.JumlahPenghuni)||0),0);
    animateNumber(document.getElementById('totalPenghuni'), totalPenghuni);
  }

  // -------------------------
  // Init
  // -------------------------
  function applyFilters(){
    const k = document.getElementById('filterKecamatan').value;
    const d = document.getElementById('filterDesa').value;
    const s = document.getElementById('searchInput').value.trim().toLowerCase();
    filteredView = [];
    globalData.forEach((row, idx) => {
      if(k && row.Kecamatan !== k) return;
      if(d && row.Desa !== d) return;
      if(s){
        const hay = ((row.Nama||'') + ' ' + (row.NoNIK||'')).toLowerCase();
        if(!hay.includes(s)) return;
      }
      filteredView.push(Object.assign({}, row, {_idx: idx}));
    });
    applySavedSort();
    sortFilteredViewIfNeeded();
    setHeaderSortUI();
    currentPage = 1;
    renderTable();
    updateChart();
    updateMap();
    updateKPI();
  }

  try{ document.getElementById('togglePerDesa').addEventListener('change', updateChart); }catch(e){}

  document.addEventListener('DOMContentLoaded', ()=>{
    const keyMap = ["Nama","NoKK","NoNIK","Alamat","Kecamatan","Desa","LuasRumah","JumlahPenghuni","Latitude","Longitude"];
    document.querySelectorAll("#dataTable thead th.sortable").forEach((th, idx) => {
      if (idx < keyMap.length) {
        th.style.cursor = "pointer";
        th.title = "Klik untuk urutkan";
        th.addEventListener("click", ()=> sortByKey(keyMap[idx], th));
      }
    });

    document.getElementById('resetSort').addEventListener('click', ()=>{
      localStorage.removeItem(LS_SORT);
      sortConfig = { key: 'Nama', asc: true };
      const headers = document.querySelectorAll("#dataTable thead th.sortable");
      if(headers.length>0) sortByKey('Nama', headers[0]);
    });

    const saved = localStorage.getItem(LS_SORT);
    if(saved){
      try{
        sortConfig = JSON.parse(saved);
      }catch(e){}
    } else {
      sortConfig = { key: 'Nama', asc: true };
    }
  });
</script>

</body>
</html>
