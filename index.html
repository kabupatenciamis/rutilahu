<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIRUCI ‚Äî Dashboard Rutilahu</title>

  <!-- CSS libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    :root {
      --page-bg: #f6f7fb;
      --card-bg: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --main-purple: #6b21a8;
    }
    body { margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: var(--page-bg); color:var(--text); }
    .container-fluid{ padding:22px; max-width:1320px; margin:auto; }
    .brand { color: var(--main-purple); font-weight:700; }
    .card { border-radius:12px; background:var(--card-bg); box-shadow: 0 6px 18px rgba(20,24,40,0.06); border:none; }

    /* KPI grid */
    .kpi-grid { display:grid; grid-template-columns: repeat(3,1fr); gap:12px; margin-bottom:16px; }
    @media (max-width:992px){ .kpi-grid { grid-template-columns: repeat(2,1fr); } }
    @media (max-width:576px){ .kpi-grid { grid-template-columns: 1fr; } }

    .kpi-card {
      padding:14px; border-radius:14px; min-height:130px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
      transition:transform .16s ease, box-shadow .16s ease;
    }
    .kpi-card:hover{ transform:translateY(-6px); box-shadow:0 12px 30px rgba(15,20,40,0.06); }
    .kpi-label{ color:var(--muted); font-weight:600; font-size:0.95rem; margin-bottom:6px; text-align:center; }
    .kpi-value{ font-weight:800; font-size:1.9rem; color:var(--text); text-align:center; }

    .kpi-card:nth-child(1){ background: linear-gradient(180deg,#e6f0ff,#fff); border:1px solid rgba(107,141,242,0.06); }
    .kpi-card:nth-child(2){ background: linear-gradient(180deg,#e9f7ec,#fff); border:1px solid rgba(34,197,94,0.06); }
    .kpi-card:nth-child(3){ background: linear-gradient(180deg,#fffaf0,#fff); border:1px solid rgba(250,204,21,0.06); }
    .kpi-card:nth-child(4){ background: linear-gradient(180deg,#f6eefc,#fff); border:1px solid rgba(107,33,168,0.06); }
    .kpi-card:nth-child(5){ background: linear-gradient(180deg,#fff3e0,#fff); border:1px solid rgba(249,115,22,0.06); }
    .kpi-card:nth-child(6){ background: linear-gradient(180deg,#fff0f6,#fff); border:1px solid rgba(244,63,94,0.06); }

    /* Charts */
    .charts-row { display:grid; grid-template-columns: 1fr 420px; gap:12px; margin-bottom:16px; }
    @media (max-width:1200px){ .charts-row{ grid-template-columns:1fr; } }
    .chart-card{ padding:12px; border-radius:12px; }

    /* Table responsive area */
.table-responsive {
  border-radius: 12px;
  overflow-x: auto;
  overflow-y: hidden;
  width: 100%;
  margin-bottom: 12px;
  background: var(--card-bg);
}

/* Table */
table#dataTable {
  width: 100%;
  min-width: 1200px; /* biar kolom tidak terlalu sempit */
  border-collapse: collapse;
}

table#dataTable thead {
  background: #0b1220;
  color: #fff;
  position: sticky;
  top: 0;
  z-index: 10;
}

table#dataTable th,
table#dataTable td {
  padding: 10px 12px;
  vertical-align: middle;
  text-align: left;
  white-space: nowrap; /* kolom tidak terbungkus */
}

table#dataTable tbody tr:hover {
  background: #f3f4f6;
}

@media (max-width: 768px) {
  table#dataTable {
    min-width: 900px;
    font-size: 0.9rem;
  }
  table#dataTable th,
  table#dataTable td {
    padding: 8px 10px;
  }
}


    /* Map under table */
    #map { height: 420px; border-radius:12px; margin-top:18px; }

    /* Popup */
    .popup-card { border-radius:10px; padding:10px; color:#0f172a; font-size:0.92rem; line-height:1.25; box-shadow: 0 8px 22px rgba(15,20,40,0.08); max-width:260px; animation: popupFadeIn .22s ease; }
    /* Popup position & styling fix */
.leaflet-popup {
  bottom: 10px !important; /* posisi lebih pas di atas marker */
}

.leaflet-popup-content-wrapper.custom-popup,
.custom-popup .leaflet-popup-content-wrapper {
  background: transparent;
  box-shadow: none;
  border: none;
  border-radius: 12px;
}

.custom-popup .leaflet-popup-content {
  margin: 0;
  padding: 0;
  background: transparent;
}

.custom-popup .leaflet-popup-tip {
  display: none; /* hilangkan segitiga bawah */
}

.popup-card {
  margin-top: -6px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.15);
  border-radius: 12px;
  padding: 10px 12px;
  width: 240px;
  animation: popupFadeIn .25s ease;
}

.popup-card::before {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 12px;
  height: 12px;
  background: inherit;
  clip-path: polygon(50% 100%, 0 0, 100% 0);
}

    .popup-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
    .popup-title { font-weight:700; font-size:1rem; margin-bottom:4px; }
    .popup-sub { color: #374151; font-size:0.9rem; }
    .popup-meta { font-size:0.88rem; color:#374151; display:flex; gap:8px; flex-wrap:wrap; }
    @keyframes popupFadeIn { from { opacity:0; transform: translateY(6px) scale(.99); } to { opacity:1; transform: translateY(0) scale(1); } }

    @media (max-width:576px){
      .popup-card { max-width:220px; font-size:0.88rem; }
      .charts-row .chart-card { padding:8px; }
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="d-flex align-items-center mb-3">
    <h3 class="me-auto brand"><i class="fa-solid fa-house-chimney"></i> SIRUCI <small class="text-muted">- Sistem Informasi Rutilahu Kabupaten Ciamis</small></h3>
    <div class="text-end">
      <div style="font-size:0.9rem;color:var(--muted);">Masuk sebagai</div>
      <div id="userRole" class="fw-bold">-</div>
      <a id="logoutBtn" class="btn btn-sm btn-outline-danger mt-1" style="display:none;"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
    </div>
  </div>

  <div class="mb-2" style="color:var(--main-purple);font-weight:600;">Data Tepat, Bantuan Cepat, Ciamis Hebat</div>

  <!-- KPI (IDs preserved; label for totalDesa changed to "Desa / Kelurahan") -->
  <div class="kpi-grid" id="kpiGrid">
    <div class="kpi-card card">
      <div class="kpi-label">Total Rutilahu</div>
      <div class="kpi-value" id="totalData">0</div>
    </div>
    <div class="kpi-card card">
      <div class="kpi-label">Kecamatan</div>
      <div class="kpi-value" id="totalKecamatan">0</div>
    </div>
    <div class="kpi-card card">
      <div class="kpi-label">Desa / Kelurahan</div>
      <div class="kpi-value" id="totalDesa">0</div> <!-- ID tetap totalDesa -->
    </div>
    <div class="kpi-card card">
      <div class="kpi-label">Total Penghuni</div>
      <div class="kpi-value" id="totalPenghuni">0</div>
    </div>
    <div class="kpi-card card">
      <div class="kpi-label">Kecukupan Ruang (CUKUP)</div>
      <div class="kpi-value" id="totalCukup">0</div>
    </div>
    <div class="kpi-card card">
      <div class="kpi-label">Kecukupan Ruang (TIDAK)</div>
      <div class="kpi-value" id="totalTidak">0</div>
    </div>
  </div>

  <!-- Charts (bar + pie) -->
  <div class="charts-row">
    <div class="card chart-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div style="font-weight:700">Bar Chart ‚Äî Jumlah per Kecamatan / Desa-Kelurahan</div>
          <div class="text-muted" style="font-size:0.85rem;">Centang "Per Desa" untuk melihat per (Desa / Kelurahan)</div>
        </div>
        <div>
          <input type="checkbox" id="togglePerDesa" /> <label for="togglePerDesa" style="font-size:0.86rem;color:var(--muted);">Per Desa</label>
        </div>
      </div>
      <div style="height:320px;"><canvas id="barKecamatan"></canvas></div>
    </div>

    <div class="card chart-card">
      <div style="font-weight:700;margin-bottom:6px;">Pie Chart ‚Äî Distribusi Kecukupan Ruang</div>
      <div style="height:320px;"><canvas id="pieKecukupan"></canvas></div>
    </div>
  </div>

  <!-- Table (with Kelurahan after Desa) -->
  <div class="card p-3 mb-3">
    <h5 class="card-title">Tabel Data</h5>

    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
      <div class="input-group" style="max-width:300px;">
        <span class="input-group-text">üîç</span>
        <input type="text" id="searchInput" class="form-control" placeholder="Cari Nama/NIK..." autocomplete="off">
      </div>

      <select id="filterKecamatan" class="form-select" style="max-width:200px;"></select>
      <select id="filterDesa" class="form-select" style="max-width:200px;"></select>
      <select id="filterKelurahan" class="form-select" style="max-width:220px;"></select>

      <div class="ms-auto btn-group">
        <label class="btn btn-outline-secondary">
          <i class="fa-solid fa-file-excel"></i> Unggah XLSX
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none;">
        </label>
        <button id="downloadTemplate" class="btn btn-outline-secondary">Template</button>
        <button class="btn btn-success" onclick="addRow()"><i class="fa-solid fa-plus"></i> Tambah Baris</button>
        <button class="btn btn-outline-primary" onclick="exportExcel()"><i class="fa-solid fa-share"></i> Ekspor XLSX</button>
        <button id="clearData" class="btn btn-danger"><i class="fa-solid fa-trash"></i> Hapus Semua</button>
      </div>
    </div>

    <div class="table-responsive">
      <table id="dataTable" class="table table-hover table-striped">
        <thead class="bg-dark text-white">
          <tr>
            <th class="sortable">Nama</th>
            <th class="sortable">No. KK</th>
            <th class="sortable">No. NIK</th>
            <th class="sortable">Alamat</th>
            <th class="sortable">Kecamatan</th>
            <th class="sortable">Desa</th>
            <th class="sortable">Kelurahan</th>
            <th class="sortable">Luas Rumah</th>
            <th class="sortable">Jml Penghuni</th>
            <th class="sortable">Kecukupan Ruang</th>
            <th class="sortable">Latitude</th>
            <th class="sortable">Longitude</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="d-flex align-items-center">
        <span>Baris per halaman:</span>
        <select id="pageSizeSel" class="form-select form-select-sm ms-2" style="width:auto;">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div id="pagination" class="btn-group"></div>
      <div id="pageInfo" class="text-muted"></div>
    </div>
  </div>

  <!-- Map (full width, below table) -->
  <div class="card p-3 mb-3">
    <h5 class="card-title">Peta Sebaran Rutilahu</h5>
    <div class="text-muted" style="font-size:0.88rem;margin-bottom:8px;">Klik peta untuk menyimpan koordinat ke baris terpilih (Admin)</div>
    <div id="map"></div>
  </div>

  <footer style="text-align:center;color:var(--muted);margin-top:18px;">¬© 2025 Pemerintah Kabupaten Ciamis ‚Äî Dinas Perumahan Rakyat, Kawasan Permukiman dan Lingkungan Hidup</footer>
</div>

<!-- Login overlay -->
<div id="login-overlay" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:2000;">
  <div class="card p-4" style="width:100%;max-width:420px;">
    <h5 class="mb-3">Login ke SIRUCI</h5>
    <div class="mb-2"><input id="adminEmail" class="form-control" value="admin@ciamis.go.id" disabled></div>
    <div class="mb-3"><input id="adminPassword" type="password" class="form-control" placeholder="Password Admin"></div>
    <div class="d-grid gap-2">
      <button id="loginAdminBtn" class="btn btn-primary">Login sebagai Admin</button>
      <button id="loginViewerBtn" class="btn btn-outline-secondary">Login sebagai Viewer</button>
    </div>
    <div id="loginErrorMsg" style="display:none;color:#c00;margin-top:8px;"></div>
  </div>
</div>

<!-- libs -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js">
// üîÑ Isi otomatis dropdown filter dari data Firebase
function fillFilterOptions() {
  const kecSelect = document.getElementById('filterKecamatan');
  const desaSelect = document.getElementById('filterDesa');
  const statusSelect = document.getElementById('filterStatus');

  // Kosongkan semua opsi lama dulu
  [kecSelect, desaSelect, statusSelect].forEach(sel => {
    sel.innerHTML = '<option value="">Semua</option>';
  });

  // Buat set unik dari data
  const kecamatanSet = new Set();
  const desaKelSet = new Set();
  const statusSet = new Set();

  globalData.forEach(r => {
    if (r.Kecamatan) kecamatanSet.add(r.Kecamatan.trim());
    if (r.Desa || r.Kelurahan) desaKelSet.add((r.Desa || r.Kelurahan).trim());
    if (r.KecukupanRuang) statusSet.add(r.KecukupanRuang.trim());
  });

  // Masukkan data ke dropdown
  Array.from(kecamatanSet).sort().forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = k;
    kecSelect.appendChild(opt);
  });

  Array.from(desaKelSet).sort().forEach(d => {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    desaSelect.appendChild(opt);
  });

  Array.from(statusSet).sort().forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    statusSelect.appendChild(opt);
  });
}

// Jalankan setelah data Firebase selesai dimuat
setTimeout(fillFilterOptions, 1500);

</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js">
// üîÑ Isi otomatis dropdown filter dari data Firebase
function fillFilterOptions() {
  const kecSelect = document.getElementById('filterKecamatan');
  const desaSelect = document.getElementById('filterDesa');
  const statusSelect = document.getElementById('filterStatus');

  // Kosongkan semua opsi lama dulu
  [kecSelect, desaSelect, statusSelect].forEach(sel => {
    sel.innerHTML = '<option value="">Semua</option>';
  });

  // Buat set unik dari data
  const kecamatanSet = new Set();
  const desaKelSet = new Set();
  const statusSet = new Set();

  globalData.forEach(r => {
    if (r.Kecamatan) kecamatanSet.add(r.Kecamatan.trim());
    if (r.Desa || r.Kelurahan) desaKelSet.add((r.Desa || r.Kelurahan).trim());
    if (r.KecukupanRuang) statusSet.add(r.KecukupanRuang.trim());
  });

  // Masukkan data ke dropdown
  Array.from(kecamatanSet).sort().forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = k;
    kecSelect.appendChild(opt);
  });

  Array.from(desaKelSet).sort().forEach(d => {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    desaSelect.appendChild(opt);
  });

  Array.from(statusSet).sort().forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    statusSelect.appendChild(opt);
  });
}

// Jalankan setelah data Firebase selesai dimuat
setTimeout(fillFilterOptions, 1500);

</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js">
// üîÑ Isi otomatis dropdown filter dari data Firebase
function fillFilterOptions() {
  const kecSelect = document.getElementById('filterKecamatan');
  const desaSelect = document.getElementById('filterDesa');
  const statusSelect = document.getElementById('filterStatus');

  // Kosongkan semua opsi lama dulu
  [kecSelect, desaSelect, statusSelect].forEach(sel => {
    sel.innerHTML = '<option value="">Semua</option>';
  });

  // Buat set unik dari data
  const kecamatanSet = new Set();
  const desaKelSet = new Set();
  const statusSet = new Set();

  globalData.forEach(r => {
    if (r.Kecamatan) kecamatanSet.add(r.Kecamatan.trim());
    if (r.Desa || r.Kelurahan) desaKelSet.add((r.Desa || r.Kelurahan).trim());
    if (r.KecukupanRuang) statusSet.add(r.KecukupanRuang.trim());
  });

  // Masukkan data ke dropdown
  Array.from(kecamatanSet).sort().forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = k;
    kecSelect.appendChild(opt);
  });

  Array.from(desaKelSet).sort().forEach(d => {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    desaSelect.appendChild(opt);
  });

  Array.from(statusSet).sort().forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    statusSelect.appendChild(opt);
  });
}

// Jalankan setelah data Firebase selesai dimuat
setTimeout(fillFilterOptions, 1500);

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
// üîÑ Isi otomatis dropdown filter dari data Firebase
function fillFilterOptions() {
  const kecSelect = document.getElementById('filterKecamatan');
  const desaSelect = document.getElementById('filterDesa');
  const statusSelect = document.getElementById('filterStatus');

  // Kosongkan semua opsi lama dulu
  [kecSelect, desaSelect, statusSelect].forEach(sel => {
    sel.innerHTML = '<option value="">Semua</option>';
  });

  // Buat set unik dari data
  const kecamatanSet = new Set();
  const desaKelSet = new Set();
  const statusSet = new Set();

  globalData.forEach(r => {
    if (r.Kecamatan) kecamatanSet.add(r.Kecamatan.trim());
    if (r.Desa || r.Kelurahan) desaKelSet.add((r.Desa || r.Kelurahan).trim());
    if (r.KecukupanRuang) statusSet.add(r.KecukupanRuang.trim());
  });

  // Masukkan data ke dropdown
  Array.from(kecamatanSet).sort().forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = k;
    kecSelect.appendChild(opt);
  });

  Array.from(desaKelSet).sort().forEach(d => {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    desaSelect.appendChild(opt);
  });

  Array.from(statusSet).sort().forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    statusSelect.appendChild(opt);
  });
}

// Jalankan setelah data Firebase selesai dimuat
setTimeout(fillFilterOptions, 1500);

</script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js">
// üîÑ Isi otomatis dropdown filter dari data Firebase
function fillFilterOptions() {
  const kecSelect = document.getElementById('filterKecamatan');
  const desaSelect = document.getElementById('filterDesa');
  const statusSelect = document.getElementById('filterStatus');

  // Kosongkan semua opsi lama dulu
  [kecSelect, desaSelect, statusSelect].forEach(sel => {
    sel.innerHTML = '<option value="">Semua</option>';
  });

  // Buat set unik dari data
  const kecamatanSet = new Set();
  const desaKelSet = new Set();
  const statusSet = new Set();

  globalData.forEach(r => {
    if (r.Kecamatan) kecamatanSet.add(r.Kecamatan.trim());
    if (r.Desa || r.Kelurahan) desaKelSet.add((r.Desa || r.Kelurahan).trim());
    if (r.KecukupanRuang) statusSet.add(r.KecukupanRuang.trim());
  });

  // Masukkan data ke dropdown
  Array.from(kecamatanSet).sort().forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = k;
    kecSelect.appendChild(opt);
  });

  Array.from(desaKelSet).sort().forEach(d => {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    desaSelect.appendChild(opt);
  });

  Array.from(statusSet).sort().forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    statusSelect.appendChild(opt);
  });
}

// Jalankan setelah data Firebase selesai dimuat
setTimeout(fillFilterOptions, 1500);

</script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js">
// üîÑ Isi otomatis dropdown filter dari data Firebase
function fillFilterOptions() {
  const kecSelect = document.getElementById('filterKecamatan');
  const desaSelect = document.getElementById('filterDesa');
  const statusSelect = document.getElementById('filterStatus');

  // Kosongkan semua opsi lama dulu
  [kecSelect, desaSelect, statusSelect].forEach(sel => {
    sel.innerHTML = '<option value="">Semua</option>';
  });

  // Buat set unik dari data
  const kecamatanSet = new Set();
  const desaKelSet = new Set();
  const statusSet = new Set();

  globalData.forEach(r => {
    if (r.Kecamatan) kecamatanSet.add(r.Kecamatan.trim());
    if (r.Desa || r.Kelurahan) desaKelSet.add((r.Desa || r.Kelurahan).trim());
    if (r.KecukupanRuang) statusSet.add(r.KecukupanRuang.trim());
  });

  // Masukkan data ke dropdown
  Array.from(kecamatanSet).sort().forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = k;
    kecSelect.appendChild(opt);
  });

  Array.from(desaKelSet).sort().forEach(d => {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    desaSelect.appendChild(opt);
  });

  Array.from(statusSet).sort().forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    statusSelect.appendChild(opt);
  });
}

// Jalankan setelah data Firebase selesai dimuat
setTimeout(fillFilterOptions, 1500);

</script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js">
// üîÑ Isi otomatis dropdown filter dari data Firebase
function fillFilterOptions() {
  const kecSelect = document.getElementById('filterKecamatan');
  const desaSelect = document.getElementById('filterDesa');
  const statusSelect = document.getElementById('filterStatus');

  // Kosongkan semua opsi lama dulu
  [kecSelect, desaSelect, statusSelect].forEach(sel => {
    sel.innerHTML = '<option value="">Semua</option>';
  });

  // Buat set unik dari data
  const kecamatanSet = new Set();
  const desaKelSet = new Set();
  const statusSet = new Set();

  globalData.forEach(r => {
    if (r.Kecamatan) kecamatanSet.add(r.Kecamatan.trim());
    if (r.Desa || r.Kelurahan) desaKelSet.add((r.Desa || r.Kelurahan).trim());
    if (r.KecukupanRuang) statusSet.add(r.KecukupanRuang.trim());
  });

  // Masukkan data ke dropdown
  Array.from(kecamatanSet).sort().forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = k;
    kecSelect.appendChild(opt);
  });

  Array.from(desaKelSet).sort().forEach(d => {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    desaSelect.appendChild(opt);
  });

  Array.from(statusSet).sort().forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    statusSelect.appendChild(opt);
  });
}

// Jalankan setelah data Firebase selesai dimuat
setTimeout(fillFilterOptions, 1500);

</script>

<script>
/* =========================
   State + Firebase
   ========================= */
const LS_SORT = 'rutilahu_sort_v1';
let globalData = [];
let filteredView = [];
let selectedGlobalIndex = null;
let chartKec = null, chartPie = null;
let markersLayer;
let currentPage = 1;
let pageSize = parseInt(localStorage.getItem('rutilahu_page_size')||'10',10);
let userRole = null;

const firebaseConfig = {
  apiKey: "AIzaSyCSdubntMjMsOFIHNl-z9f6GTnBEJsz8qk",
  authDomain: "rutilahu-ciamis.firebaseapp.com",
  projectId: "rutilahu-ciamis",
  storageBucket: "rutilahu-ciamis.appspot.com",
  messagingSenderId: "785824428340",
  appId: "1:785824428340:web:aec44a0b8307d7ed247561",
  databaseURL: "https://rutilahu-ciamis-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* Helpers */
function safeFloat(v){ const n=parseFloat(v); return isNaN(n)? null : n; }
function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* normalizeNameRaw: keep words (do not strip 'desa'/'kelurahan') */
function normalizeNameRaw(name){
  return (name||'').toString().toLowerCase()
    .replace(/\r|\n/g,' ')
    .replace(/[^a-z0-9\s]/g,'')
    .replace(/\s+/g,' ')
    .trim();
}
function canonicalDisplay(name){
  const n = normalizeNameRaw(name);
  if(!n) return n;
  return n.split(' ').map(w=> w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
}

/* Map init */
const map = L.map('map').setView([-7.33,108.33],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: '¬© OpenStreetMap' }).addTo(map);
markersLayer = L.layerGroup().addTo(map);

/* House SVG icon generator */
function createHouseIconHex(hexColor='#6b21a8'){
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24"><path fill="${hexColor}" d="M12 3l8 7h-3v8h-4v-5H11v5H7v-8H4z"/></svg>`;
  return L.icon({ iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(svg), iconSize:[36,36], iconAnchor:[18,36], popupAnchor:[0,-30] });
}

/* status color */
function statusColor(status){
  if(!status) return {hex:'#6b21a8', bg:'#f3e5f5'};
  const s = status.toString().toLowerCase();
  if(s.includes('cukup')) return {hex:'#16a34a', bg:'#e8f5e9'};
  if(s.includes('tidak')) return {hex:'#dc2626', bg:'#fdecea'};
  return {hex:'#6b21a8', bg:'#f3e5f5'};
}

/* popup HTML (include Kelurahan) */
function buildPopupHTML(r){
  const sc = statusColor(r.KecukupanRuang || '');
  const nama = escapeHtml(r.Nama || '-');
  const nik = escapeHtml(r.NoNIK || '-');
  const alamat = escapeHtml(r.Alamat || '-');
  const kec = escapeHtml(r.Kecamatan || '-');
  const desa = escapeHtml(r.Desa || '-');
  const kel = escapeHtml(r.Kelurahan || '-');
  const luas = (r.LuasRumah || '') + (r.LuasRumah ? ' m¬≤' : '');
  const penghuni = r.JumlahPenghuni || '';
  const status = escapeHtml(r.KecukupanRuang || '(Belum)');
  return `
    <div class="popup-card" style="background:${sc.bg};">
      <div class="popup-row"><span style="font-size:1.1rem">üè†</span>
        <div><div class="popup-title">${nama}</div><div class="popup-sub">üÜî ${nik}</div></div></div>
      <div class="popup-sub">üìç ${alamat}</div><div style="height:6px;"></div>
      <div class="popup-meta"><div>üè° ${kec} | ${desa} / ${kel}</div><div>üìè ${luas} ${luas? '|' : ''} üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${penghuni}</div></div>
      <div style="height:8px;"></div><div style="font-weight:700">üìä Kecukupan: ${status}</div>
    </div>
  `;
}

/* Update map markers */
function updateMap(){
  markersLayer.clearLayers();
  filteredView.forEach(r=>{
    if(r.Latitude != null && r.Longitude != null){
      const st = statusColor(r.KecukupanRuang || '');
      const icon = createHouseIconHex(st.hex);
      const m = L.marker([r.Latitude, r.Longitude], {icon});
      m.bindPopup(buildPopupHTML(r), {
  className: 'custom-popup',
  offset: L.point(0, -20),   // posisi popup sedikit di atas ikon rumah
  maxWidth: 280,
  closeButton: true,
  autoPanPaddingTopLeft: L.point(40, 40),
  autoPanPaddingBottomRight: L.point(40, 40)
});
      markersLayer.addLayer(m);
    }
  });
}

/* Charts: perDesa uses "Kecamatan - Desa / Kelurahan" as label to keep uniqueness */
function updateCharts(){
  const perDesa = document.getElementById('togglePerDesa')?.checked;
  const group = {};
  const pie = {};

  filteredView.forEach(r=>{
    const kec = (r.Kecamatan||'(Belum)').trim() || '(Belum)';
    const desa = (r.Desa||'(Belum)').trim() || '(Belum)';
    const kel = (r.Kelurahan||'').trim();
    const key = perDesa ? `${kec} - ${desa}${kel? ' / ' + kel : ''}` : kec;
    group[key] = (group[key] || 0) + 1;

    const st = (r.KecukupanRuang||'(Belum)').toString();
    pie[st] = (pie[st] || 0) + 1;
  });

  const labels = Object.keys(group).sort((a,b)=> group[b]-group[a]);
  const values = labels.map(k=> group[k]);

  const pieLabels = Object.keys(pie);
  const pieValues = pieLabels.map(k=> pie[k]);

  if(chartKec) chartKec.destroy();
  if(chartPie) chartPie.destroy();

  const ctxK = document.getElementById('barKecamatan').getContext('2d');
  chartKec = new Chart(ctxK, {
    type:'bar',
    data:{ labels, datasets:[{ label: perDesa ? 'Jumlah per Desa/Kelurahan' : 'Jumlah per Kecamatan', data: values, backgroundColor: perDesa ? 'rgba(34,197,94,0.85)' : 'rgba(107,141,242,0.9)' }] },
    options:{
      responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }}, animation:{ duration:700 },
      scales:{ x:{ ticks:{ color:'#475569', autoSkip:false, maxRotation:60, minRotation:0 } }, y:{ ticks:{ color:'#475569' } } }
    }
  });

  const ctxP = document.getElementById('pieKecukupan').getContext('2d');
  chartPie = new Chart(ctxP, {
    type:'pie',
    data:{ labels: pieLabels, datasets:[{ data: pieValues, backgroundColor:['#6b8df2','#22c55e','#f59e0b','#ef4444','#a78bfa','#94a3b8'] }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' }}, animation:{ duration:700 } }
  });
}

/* Filters: populate kecamatan, desa, kelurahan filters */
function populateFilters(){
  const kecSel = document.getElementById('filterKecamatan');
  const desaSel = document.getElementById('filterDesa');
  const kelSel = document.getElementById('filterKelurahan');
  const selectedKec = kecSel.value;
  const selectedDesa = desaSel.value;
  const selectedKel = kelSel.value;

  const kecSet = new Set(globalData.map(d=> (d.Kecamatan||'').trim()).filter(Boolean));
  kecSel.innerHTML = '<option value="">Semua</option>';
  Array.from(kecSet).sort().forEach(k => { kecSel.innerHTML += `<option value="${k}" ${k===selectedKec?'selected':''}>${k}</option>`; });

  // Desa options (respect selected kecamatan)
  const desaMap = new Map();
  globalData.forEach(d=>{
    if(selectedKec && ((d.Kecamatan||'') !== selectedKec)) return;
    const raw = (d.Desa||''); const key = normalizeNameRaw(raw);
    if(!key) return;
    if(!desaMap.has(key)) desaMap.set(key, raw.trim() || canonicalDisplay(key));
  });
  desaSel.innerHTML = '<option value="">Semua Desa</option>';
  Array.from(desaMap.entries()).sort((a,b)=> a[1].localeCompare(b[1])).forEach(([key,label])=>{
    desaSel.innerHTML += `<option value="${key}" ${key===selectedDesa?'selected':''}>${label}</option>`;
  });

  // Kelurahan options (respect selected kecamatan & desa)
  const kelMap = new Map();
  globalData.forEach(d=>{
    if(selectedKec && ((d.Kecamatan||'') !== selectedKec)) return;
    if(selectedDesa){
      const dk = normalizeNameRaw(d.Desa||'');
      if(dk !== selectedDesa) return;
    }
    const rawk = (d.Kelurahan||''); const keyk = normalizeNameRaw(rawk);
    if(!keyk) return;
    if(!kelMap.has(keyk)) kelMap.set(keyk, rawk.trim() || canonicalDisplay(keyk));
  });
  kelSel.innerHTML = '<option value="">Semua Kelurahan</option>';
  Array.from(kelMap.entries()).sort((a,b)=> a[1].localeCompare(b[1])).forEach(([key,label])=>{
    kelSel.innerHTML += `<option value="${key}" ${key===selectedKel?'selected':''}>${label}</option>`;
  });
}

/* Sorting */
let sortConfig = { key:null, asc:true };
function applySavedSort(){ const s = localStorage.getItem(LS_SORT); if(s) try{ sortConfig = JSON.parse(s); }catch(e){} }
function sortFilteredViewIfNeeded(){ if(!sortConfig.key) return; filteredView.sort((a,b)=>{ const va = (''+(a[sortConfig.key]||'')).toLowerCase(); const vb = (''+(b[sortConfig.key]||'')).toLowerCase(); if(va<vb) return sortConfig.asc? -1:1; if(va>vb) return sortConfig.asc?1:-1; return 0; }); }
function setHeaderSortUI(){ document.querySelectorAll("#dataTable thead th.sortable").forEach(th=>th.classList.remove('asc','desc')); const keyMap = ["Nama","NoKK","NoNIK","Alamat","Kecamatan","Desa","Kelurahan","LuasRumah","JumlahPenghuni","KecukupanRuang","Latitude","Longitude"]; const idx = keyMap.indexOf(sortConfig.key); if(idx>=0){ const ths = document.querySelectorAll("#dataTable thead th.sortable"); if(ths[idx]) ths[idx].classList.add(sortConfig.asc?'asc':'desc'); } }
function sortByKey(key, th){ if(sortConfig.key===key) sortConfig.asc=!sortConfig.asc; else { sortConfig.key=key; sortConfig.asc=true; } sortFilteredViewIfNeeded(); currentPage=1; renderTable(); setHeaderSortUI(); localStorage.setItem(LS_SORT, JSON.stringify(sortConfig)); }

/* Table rendering */
const tbody = document.querySelector('#dataTable tbody');
function renderTable(){
  tbody.innerHTML=''; const total = filteredView.length; const totalPages = Math.max(1, Math.ceil(total/pageSize));
  if(currentPage>totalPages) currentPage=totalPages;
  const start=(currentPage-1)*pageSize; const end=start+pageSize; const pageSlice = filteredView.slice(start,end);

  pageSlice.forEach(r=>{
    const tr = document.createElement('tr'); tr.dataset.idx = r._idx;
    const isAdmin = userRole === 'admin';
    tr.innerHTML = `
      <td contenteditable="${isAdmin}">${escapeHtml(r.Nama)}</td>
      <td contenteditable="${isAdmin}">${escapeHtml(r.NoKK)}</td>
      <td contenteditable="${isAdmin}">${escapeHtml(r.NoNIK)}</td>
      <td contenteditable="${isAdmin}">${escapeHtml(r.Alamat)}</td>
      <td contenteditable="${isAdmin}">${escapeHtml(r.Kecamatan)}</td>
      <td contenteditable="${isAdmin}">${escapeHtml(r.Desa)}</td>
      <td contenteditable="${isAdmin}">${escapeHtml(r.Kelurahan || '')}</td>
      <td contenteditable="${isAdmin}">${r.LuasRumah ?? ''}</td>
      <td contenteditable="${isAdmin}">${r.JumlahPenghuni ?? ''}</td>
      <td contenteditable="${isAdmin}">${escapeHtml(r.KecukupanRuang ?? '')}</td>
      <td contenteditable="${isAdmin}">${r.Latitude ?? ''}</td>
      <td contenteditable="${isAdmin}">${r.Longitude ?? ''}</td>
      <td>
        <button class="btn btn-sm btn-success small-btn" onclick="saveRow(this)" style="display:${isAdmin?'':'none'}"><i class="fa-solid fa-save"></i></button>
        <button class="btn btn-sm btn-danger small-btn" onclick="deleteRow(this)" style="display:${isAdmin?'':'none'}"><i class="fa-solid fa-trash"></i></button>
      </td>`;
    tr.addEventListener('click', function(e){ if(e.target.tagName==='BUTTON') return; selectRow(r._idx, tr); });
    tbody.appendChild(tr);
  });

  renderPagination(total, totalPages);
  document.getElementById('pageInfo').innerText = `Menampilkan ${total===0?0:start+1} - ${Math.min(total,end)} dari ${total} baris`;
}
function renderPagination(total, totalPages){
  const pg = document.getElementById('pagination'); pg.innerHTML='';
  const createBtn=(txt,onClick,disabled=false,cls='btn-secondary')=>{ const b=document.createElement('button'); b.type='button'; b.className=`btn ${cls} page-btn`; if(disabled) b.disabled=true; b.innerText=txt; b.addEventListener('click',onClick); return b; };
  pg.appendChild(createBtn('‚ü®', ()=>{ if(currentPage>1){ currentPage--; renderTable(); } }, currentPage===1));
  const maxButtons = 5; let start = Math.max(1, currentPage - Math.floor(maxButtons/2)); let end = Math.min(totalPages, start + maxButtons -1);
  if(end - start < maxButtons -1) start = Math.max(1, end - maxButtons +1);
  for(let p=start;p<=end;p++){ const cls = p===currentPage ? 'btn-primary' : 'btn-outline-secondary'; pg.appendChild(createBtn(p, ()=>{ currentPage=p; renderTable(); }, false, cls)); }
  pg.appendChild(createBtn('‚ü©', ()=>{ if(currentPage<totalPages){ currentPage++; renderTable(); } }, currentPage===totalPages));
}

/* Row CRUD */
function selectRow(globalIdx, trEl){ document.querySelectorAll('#dataTable tbody tr').forEach(t=>t.classList.remove('selected')); trEl.classList.add('selected'); selectedGlobalIndex = globalIdx; }
function addRow(){ if(userRole!=='admin') return; const newObj={Nama:'',NoKK:'',NoNIK:'',Alamat:'',Kecamatan:'',Desa:'',Kelurahan:'',LuasRumah:0,JumlahPenghuni:0,KecukupanRuang:'',Latitude:null,Longitude:null}; globalData.push(newObj); populateFilters(); applyFilters(); saveToFirebase(); selectedGlobalIndex = globalData.length-1; }
function saveRow(btn){ if(userRole!=='admin') return; const tr = btn.closest('tr'); const idx = parseInt(tr.dataset.idx); const cells = tr.querySelectorAll('td');
  globalData[idx] = {
    Nama: cells[0].innerText.trim(),
    NoKK: cells[1].innerText.trim(),
    NoNIK: cells[2].innerText.trim(),
    Alamat: cells[3].innerText.trim(),
    Kecamatan: cells[4].innerText.trim(),
    Desa: cells[5].innerText.trim(),
    Kelurahan: cells[6].innerText.trim(),
    LuasRumah: safeFloat(cells[7].innerText) || 0,
    JumlahPenghuni: parseInt(cells[8].innerText) || 0,
    KecukupanRuang: cells[9].innerText.trim() || '',
    Latitude: safeFloat(cells[10].innerText),
    Longitude: safeFloat(cells[11].innerText)
  };
  populateFilters(); applyFilters(); saveToFirebase();
}
function deleteRow(btn){ if(userRole!=='admin') return; const tr=btn.closest('tr'); const idx=parseInt(tr.dataset.idx); if(!confirm('Hapus data ini?')) return; globalData.splice(idx,1); populateFilters(); applyFilters(); saveToFirebase(); selectedGlobalIndex=null; }

/* KPI animated count-up: totalDesa now counts unique Kecamatan+Desa+Kelurahan */
function animateNumber(element, newValue, duration = 900){
  if(!element) return;
  const start = parseInt(String(element.innerText).replace(/\D/g,'')) || 0; const diff = newValue - start; const t0 = performance.now();
  function frame(t){ const p = Math.min((t - t0)/duration,1); const v = Math.floor(start + diff * p); element.innerText = v.toLocaleString('id-ID'); if(p<1) requestAnimationFrame(frame); }
  requestAnimationFrame(frame);
}
function updateKPI(){
  const data = (Array.isArray(filteredView) && filteredView.length>0)? filteredView : globalData;
  animateNumber(document.getElementById('totalData'), data.length);

  const kecSet = new Set(data.map(d=> (d.Kecamatan||'').trim().toLowerCase()).filter(Boolean));
  animateNumber(document.getElementById('totalKecamatan'), kecSet.size);

  // Unique combination Kecamatan + Desa + Kelurahan
  const desaKelSet = new Set(data.map(d => {
    const kec = (d.Kecamatan||'').trim().toLowerCase();
    const desa = (d.Desa||'').trim().toLowerCase();
    const kel = (d.Kelurahan||'').trim().toLowerCase();
    return `${kec}||${desa}||${kel}`;
  }).filter(v=> v && v !== '||'));
  animateNumber(document.getElementById('totalDesa'), desaKelSet.size);

  const totalPenghuni = data.reduce((s,d)=> s + (parseInt(d.JumlahPenghuni)||0),0); animateNumber(document.getElementById('totalPenghuni'), totalPenghuni);

  const totalCukup = data.filter(d=> d.KecukupanRuang && d.KecukupanRuang.toLowerCase().includes('cukup')).length;
  const totalTidak = data.filter(d=> d.KecukupanRuang && d.KecukupanRuang.toLowerCase().includes('tidak')).length;
  animateNumber(document.getElementById('totalCukup'), totalCukup);
  animateNumber(document.getElementById('totalTidak'), totalTidak);
}

/* Filters apply */
function applyFilters(){
  const k = document.getElementById('filterKecamatan').value;
  const d = document.getElementById('filterDesa').value;
  const kel = document.getElementById('filterKelurahan').value;
  const s = document.getElementById('searchInput').value.trim().toLowerCase();

  filteredView = [];
  globalData.forEach((row, idx)=>{
    if(k && row.Kecamatan !== k) return;
    if(d){ const rowKey = normalizeNameRaw(row.Desa||''); if(rowKey !== d) return; }
    if(kel){ const rowK = normalizeNameRaw(row.Kelurahan||''); if(rowK !== kel) return; }
    if(s){ const hay = (((row.Nama||'') + ' ' + (row.NoNIK||'')).toLowerCase()); if(!hay.includes(s)) return; }
    filteredView.push(Object.assign({}, row, {_idx: idx}));
  });

  applySavedSort(); sortFilteredViewIfNeeded(); setHeaderSortUI();
  currentPage = 1; renderTable(); updateCharts(); updateMap(); updateKPI();
}

/* File import/export (Kelurahan included) */
document.getElementById('fileInput').addEventListener('change', handleFile, false);
function handleFile(ev){ const f = ev.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = function(e){ const data = new Uint8Array(e.target.result); const wb = XLSX.read(data,{type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]]; const arr = XLSX.utils.sheet_to_json(ws,{defval:''});
  globalData = arr.map(r=>({
    Nama: r.Nama||r.nama||'',
    NoKK: r.NoKK||r.No_KK||'',
    NoNIK: r.NoNIK||r.No_NIK||'',
    Alamat: r.Alamat||r.alamat||'',
    Kecamatan: r.Kecamatan||r.kecamatan||'',
    Desa: r.Desa||r.desa||'',
    Kelurahan: r.Kelurahan||r.kelurahan||'',
    LuasRumah: safeFloat(r.LuasRumah||r.luas)||0,
    JumlahPenghuni: parseInt(r.JumlahPenghuni||r.jumlah)||0,
    KecukupanRuang: (r.KecukupanRuang||'').toString(),
    Latitude: safeFloat(r.Latitude||r.lat),
    Longitude: safeFloat(r.Longitude||r.lng)
  }));
  populateFilters(); applyFilters(); saveToFirebase(); }; reader.readAsArrayBuffer(f); }

function exportExcel(){ const out = globalData.map(r=> ({ Nama:r.Nama||'', NoKK:r.NoKK||'', NoNIK:r.NoNIK||'', Alamat:r.Alamat||'', Kecamatan:r.Kecamatan||'', Desa:r.Desa||'', Kelurahan:r.Kelurahan||'', LuasRumah:r.LuasRumah||0, JumlahPenghuni:r.JumlahPenghuni||0, KecukupanRuang:r.KecukupanRuang||'', Latitude:r.Latitude||'', Longitude:r.Longitude||'' })); const ws = XLSX.utils.json_to_sheet(out); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Rutilahu'); XLSX.writeFile(wb, 'Rutilahu_Ciamis_export.xlsx'); }
document.getElementById('downloadTemplate').addEventListener('click', ()=>{ const headers = [{Nama:'Contoh',NoKK:'3201...',NoNIK:'3510...',Alamat:'Jl. Contoh',Kecamatan:'Contoh Kec',Desa:'Contoh Desa',Kelurahan:'Contoh Kel',LuasRumah:36,JumlahPenghuni:4,KecukupanRuang:'Cukup',Latitude:-7.333,Longitude:108.333}]; const ws = XLSX.utils.json_to_sheet(headers,{header:['Nama','NoKK','NoNIK','Alamat','Kecamatan','Desa','Kelurahan','LuasRumah','JumlahPenghuni','KecukupanRuang','Latitude','Longitude']}); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Template'); XLSX.writeFile(wb, 'Template_Rutilahu.xlsx'); });

document.getElementById('clearData').addEventListener('click', ()=>{ if(userRole!=='admin') return; if(!confirm('Kosongkan semua data?')) return; globalData=[]; applyFilters(); populateFilters(); saveToFirebase(); });

/* Firebase sync */
function saveToFirebase(){ if(userRole==='admin'){ db.ref('rutilahu_data').set(globalData).catch(e=>console.error('Firebase save failed',e)); } }
function loadFromFirebase(){ db.ref('rutilahu_data').on('value', snapshot=>{ const data = snapshot.val(); if(Array.isArray(data)) globalData = data.map(r=>({ Nama:r.Nama||'', NoKK:r.NoKK||'', NoNIK:r.NoNIK||'', Alamat:r.Alamat||'', Kecamatan:r.Kecamatan||'', Desa:r.Desa||'', Kelurahan:r.Kelurahan||'', LuasRumah: safeFloat(r.LuasRumah)||0, JumlahPenghuni: parseInt(r.JumlahPenghuni)||0, KecukupanRuang: r.KecukupanRuang||'', Latitude: safeFloat(r.Latitude), Longitude: safeFloat(r.Longitude) })); else globalData=[]; populateFilters(); applyFilters(); }, err=> console.error('Firebase load error',err)); }

/* Auth & UI */
const adminEmail = 'admin@ciamis.go.id';
auth.onAuthStateChanged(user=>{ if(user){ if(user.isAnonymous) userRole='viewer'; else if(user.email===adminEmail) userRole='admin'; else userRole='viewer'; applyUserRole(); loadFromFirebase(); } else { userRole=null; applyUserRole(); showLoginOverlay(); } });
function showLoginOverlay(){ document.getElementById('login-overlay').style.display='flex'; document.body.style.overflow='hidden'; }
function hideLoginOverlay(){ document.getElementById('login-overlay').style.display='none'; document.body.style.overflow=''; }
function applyUserRole(){ const isAdmin = userRole==='admin'; document.getElementById('fileInput').disabled = !isAdmin; document.getElementById('downloadTemplate').disabled = !isAdmin; document.querySelectorAll('#dataTable tbody td[contenteditable]').forEach(el=>el.setAttribute('contenteditable', isAdmin)); document.querySelectorAll('.btn-danger, .btn-success').forEach(el=>el.style.display = isAdmin? '':'none'); document.getElementById('logoutBtn').style.display = userRole? '':'none'; if(userRole) hideLoginOverlay(); updateUserRoleIndicator(); }
document.getElementById('loginAdminBtn').addEventListener('click', ()=>{ const pw = document.getElementById('adminPassword').value; const err = document.getElementById('loginErrorMsg'); auth.signInWithEmailAndPassword(adminEmail, pw).then(()=>err.style.display='none').catch(e=>{ err.style.display='block'; err.innerText = 'Login gagal: ' + e.message; }); });
document.getElementById('loginViewerBtn').addEventListener('click', ()=>{ auth.signInAnonymously().catch(e=>alert('Viewer login gagal: '+e.message)); });
document.getElementById('logoutBtn').addEventListener('click', ()=>{ auth.signOut().catch(e=>console.error('Logout error',e)); });
function updateUserRoleIndicator(){ const el = document.getElementById('userRole'); el.classList.remove('text-success','text-muted'); if(userRole==='admin'){ el.textContent='Admin'; el.classList.add('text-success'); } else if(userRole==='viewer'){ el.textContent='Viewer'; el.classList.add('text-muted'); } else el.textContent='-'; }

/* Map click to save coords (Admin) */
map.on('click', function(e){
  if(userRole !== 'admin'){ alert('Anda tidak memiliki izin untuk mengedit.'); return; }
  const lat = parseFloat(e.latlng.lat.toFixed(6)); const lng = parseFloat(e.latlng.lng.toFixed(6));
  if(selectedGlobalIndex === null){ alert('Pilih baris pada tabel terlebih dahulu.'); return; }
  globalData[selectedGlobalIndex].Latitude = lat; globalData[selectedGlobalIndex].Longitude = lng;
  applyFilters(); saveToFirebase();
  const m = L.marker([lat,lng], {icon: createHouseIconHex('#6b21a8')}).addTo(map).bindPopup('Koordinat disimpan').openPopup();
  setTimeout(()=> map.removeLayer(m), 1200);
});

/* Init bindings */
document.getElementById('filterKecamatan').addEventListener('change', ()=>{ populateFilters(); applyFilters(); });
document.getElementById('filterDesa').addEventListener('change', ()=>{ populateFilters(); applyFilters(); });
document.getElementById('filterKelurahan').addEventListener('change', applyFilters);
document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('pageSizeSel').value = pageSize;
document.getElementById('pageSizeSel').addEventListener('change', (e)=>{ pageSize = parseInt(e.target.value,10); localStorage.setItem('rutilahu_page_size', String(pageSize)); currentPage=1; renderTable(); });
document.getElementById('togglePerDesa')?.addEventListener('change', updateCharts);

/* Sortable headers */
document.addEventListener('DOMContentLoaded', ()=>{
  const keyMap = ["Nama","NoKK","NoNIK","Alamat","Kecamatan","Desa","Kelurahan","LuasRumah","JumlahPenghuni","KecukupanRuang","Latitude","Longitude"];
  document.querySelectorAll("#dataTable thead th.sortable").forEach((th, idx)=>{
    if(idx < keyMap.length){ th.style.cursor='pointer'; th.title='Klik untuk urutkan'; th.addEventListener('click', ()=> sortByKey(keyMap[idx], th)); }
  });
  applySavedSort(); updateUserRoleIndicator();
});

/* Manual refresh util */
function refreshAll(){ populateFilters(); applyFilters(); updateCharts(); updateMap(); updateKPI(); }

/* End */

// üîÑ Isi otomatis dropdown filter dari data Firebase
function fillFilterOptions() {
  const kecSelect = document.getElementById('filterKecamatan');
  const desaSelect = document.getElementById('filterDesa');
  const statusSelect = document.getElementById('filterStatus');

  // Kosongkan semua opsi lama dulu
  [kecSelect, desaSelect, statusSelect].forEach(sel => {
    sel.innerHTML = '<option value="">Semua</option>';
  });

  // Buat set unik dari data
  const kecamatanSet = new Set();
  const desaKelSet = new Set();
  const statusSet = new Set();

  globalData.forEach(r => {
    if (r.Kecamatan) kecamatanSet.add(r.Kecamatan.trim());
    if (r.Desa || r.Kelurahan) desaKelSet.add((r.Desa || r.Kelurahan).trim());
    if (r.KecukupanRuang) statusSet.add(r.KecukupanRuang.trim());
  });

  // Masukkan data ke dropdown
  Array.from(kecamatanSet).sort().forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = k;
    kecSelect.appendChild(opt);
  });

  Array.from(desaKelSet).sort().forEach(d => {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    desaSelect.appendChild(opt);
  });

  Array.from(statusSet).sort().forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    statusSelect.appendChild(opt);
  });
}

// Jalankan setelah data Firebase selesai dimuat
setTimeout(fillFilterOptions, 1500);

</script>
</body>
</html>
