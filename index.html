<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIRUCI â€” Dashboard RTLH (Firebase)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>

  <style>
    body { background: #f4f7fa; }
    .card { border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.06); }
    #map { height: 400px; border-radius: 8px; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h3 class="mb-3">ğŸ  SIRUCI â€” Sistem Informasi RTLH Kabupaten Ciamis</h3>

    <div class="mb-3">
      <label class="form-label">Unggah file Excel (.xlsx)</label>
      <input type="file" id="fileInput" class="form-control" accept=".xlsx,.xls">
    </div>

    <div class="mb-3">
      <button class="btn btn-success" onclick="addRow()">â• Tambah Data</button>
      <button class="btn btn-warning" onclick="exportExcel()">â¬‡ï¸ Export Excel</button>
    </div>

    <div class="card p-3 mb-3">
      <h5>ğŸ“‹ Data Rutilahu</h5>
      <div class="table-responsive">
        <table class="table table-striped" id="dataTable">
          <thead>
            <tr>
              <th>Nama</th>
              <th>No KK</th>
              <th>No NIK</th>
              <th>Alamat</th>
              <th>Kecamatan</th>
              <th>Desa</th>
              <th>Luas Rumah</th>
              <th>Jumlah Penghuni</th>
              <th>Latitude</th>
              <th>Longitude</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card p-3">
      <h5>ğŸ—ºï¸ Peta Sebaran</h5>
      <div id="map"></div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
  // -------------------------
  // Firebase Config
  // -------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCSdubntMjMsOFIHNl-z9f6GTnBEJsz8qk",
  authDomain: "rutilahu-ciamis.firebaseapp.com",
  projectId: "rutilahu-ciamis",
  storageBucket: "rutilahu-ciamis.firebasestorage.app",
  messagingSenderId: "785824428340",
  appId: "1:785824428340:web:aec44a0b8307d7ed247561",
  measurementId: "G-N9TG2JB4C1"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // -------------------------
  // State
  // -------------------------
  let globalData = [];
  let selectedIndex = null;
  const tbody = document.querySelector('#dataTable tbody');
  let map = L.map('map').setView([-7.33, 108.33], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: 'Â© OpenStreetMap' }).addTo(map);

  // -------------------------
  // Firebase functions
  // -------------------------
  async function saveToFirebase(){
    try {
      const colRef = db.collection("rutilahu");
      const snap = await colRef.get();
      const batch = db.batch();
      snap.forEach(doc => batch.delete(doc.ref));
      await batch.commit();

      for (let r of globalData){
        await colRef.add(r);
      }
      console.log("âœ… Data tersimpan di Firebase");
    } catch(e){
      console.error("âŒ Gagal simpan ke Firebase:", e);
    }
  }

  async function loadFromFirebase(){
    try {
      const colRef = db.collection("rutilahu");
      const snap = await colRef.get();
      globalData = snap.docs.map(d => d.data());
      console.log("ğŸ“¥ Data dimuat dari Firebase:", globalData.length, "baris");
      renderTable();
      updateMap();
    } catch(e){
      console.error("âŒ Gagal ambil data dari Firebase:", e);
    }
  }

  // -------------------------
  // Table render
  // -------------------------
  function renderTable(){
    tbody.innerHTML = '';
    globalData.forEach((r, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td contenteditable="true">${r.Nama||''}</td>
        <td contenteditable="true">${r.NoKK||''}</td>
        <td contenteditable="true">${r.NoNIK||''}</td>
        <td contenteditable="true">${r.Alamat||''}</td>
        <td contenteditable="true">${r.Kecamatan||''}</td>
        <td contenteditable="true">${r.Desa||''}</td>
        <td contenteditable="true">${r.LuasRumah||0}</td>
        <td contenteditable="true">${r.JumlahPenghuni||0}</td>
        <td contenteditable="true">${r.Latitude||''}</td>
        <td contenteditable="true">${r.Longitude||''}</td>
        <td><button class="btn btn-sm btn-success" onclick="saveRow(${idx}, this)">ğŸ’¾</button>
            <button class="btn btn-sm btn-danger" onclick="deleteRow(${idx})">ğŸ—‘ï¸</button></td>`;
      tbody.appendChild(tr);
    });
  }

  function addRow(){
    globalData.push({Nama:'',NoKK:'',NoNIK:'',Alamat:'',Kecamatan:'',Desa:'',LuasRumah:0,JumlahPenghuni:0,Latitude:null,Longitude:null});
    renderTable();
    saveToFirebase();
  }

  function saveRow(idx, btn){
    const tr = btn.closest('tr').children;
    globalData[idx] = {
      Nama: tr[0].innerText,
      NoKK: tr[1].innerText,
      NoNIK: tr[2].innerText,
      Alamat: tr[3].innerText,
      Kecamatan: tr[4].innerText,
      Desa: tr[5].innerText,
      LuasRumah: parseFloat(tr[6].innerText)||0,
      JumlahPenghuni: parseInt(tr[7].innerText)||0,
      Latitude: parseFloat(tr[8].innerText)||null,
      Longitude: parseFloat(tr[9].innerText)||null
    };
    saveToFirebase();
  }

  function deleteRow(idx){
    if(!confirm("Hapus data ini?")) return;
    globalData.splice(idx,1);
    renderTable();
    saveToFirebase();
  }

  // -------------------------
  // Map update
  // -------------------------
  function updateMap(){
    map.eachLayer(layer => { if(layer instanceof L.Marker) map.removeLayer(layer); });
    globalData.forEach(r=>{
      if(r.Latitude && r.Longitude){
        L.marker([r.Latitude, r.Longitude]).addTo(map)
          .bindPopup(`<b>${r.Nama}</b><br>${r.Alamat}`);
      }
    });
  }

  map.on('click', function(e){
    if(selectedIndex===null){ alert("Pilih baris tabel dulu."); return; }
    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);
    globalData[selectedIndex].Latitude = parseFloat(lat);
    globalData[selectedIndex].Longitude = parseFloat(lng);
    renderTable();
    saveToFirebase();
    updateMap();
  });

  // -------------------------
  // Init
  // -------------------------
  loadFromFirebase();
  </script>
</body>
</html>
